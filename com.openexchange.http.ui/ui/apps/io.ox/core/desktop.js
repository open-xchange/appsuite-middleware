define("io.ox/core/desktop",["io.ox/core/event","io.ox/core/extensions","io.ox/core/extPatterns/links","io.ox/core/cache"],function(a,b,c,d){var e,f,g,h;return"use strict",$.quickSettings=function(){return function(a,b,c){var d=$(a),e=$(b);c=$(c),e.hasClass("quick-settings")||(d.css({position:"absolute",zIndex:2}),d.data("top",parseInt(d.css("top")||0,10)),e.addClass("quick-settings").css({position:"absolute",zIndex:1,top:(e.css("top")||0)+"px",right:"0px",height:"auto",left:"0px",minHeight:"100px"
})),c.off("click").on("dblclick",!1).on("click",function(){var a,b;return window.container=d,window.config=e,a=d.data("top"),c.data("open")!==!0?(c.data("open",!0),e.show(),b=Math.max(e.outerHeight(),25),d.stop().animate({top:a+b+"px"},250)):(c.data("open",!1),d.stop().animate({top:a+"px"},250,function(){e.hide()})),!1})}}(),e=null,f=$("#io-ox-core"),g=$("#io-ox-topbar"),h=function(a,b,c,d){var f=$("<div>").addClass("launcher").append(_.isString(b)?$.txt(b):b).hover(function(){$(this).addClass("hover"
)},function(){$(this).removeClass("hover")}).on("click",function(){var a=$(this),b;_.isFunction(c)?(b=a.contents(),a.css("width",a.width()+"px").text(" ").busy(),(c.call(this)||$.when()).done(function(){a.idle().empty().append(b).css("width","")})):(a.css("backgroundColor","#800000"),setTimeout(function(){a.css("backgroundColor","")},500))});function h(a){var b=$("#io-ox-topbar"),c,d=a.getName()||a.id;if((c=b.find(".launcher[data-app-id="+$.escape(d)+"]")).length)return c;else return null}d&&f.tooltip
({title:d,placement:"bottom",animation:!1});var i=e,j;return a==="left"&&i&&i.app&&(j=h(i.app))?f.hide().insertAfter(j).fadeIn(1e3):a==="left"?f.appendTo(g):f.addClass("right").appendTo(g),f},f.show(),ox.ui.running=[],ox.ui.createApp=function(){function e(d){var e=$.extend({title:"",icon:null,id:"app-"+c++},d||{}),f=function(){return $.Deferred().resolve()},g=f,h=f,i=null,j=!1,k=null,l=_.now()+"."+String(Math.random()).substr(3,4),m="",n=null,o=this;this.getUniqueId=function(){return l};function p
(){o.failSave&&b.get("savepoints").done(function(a){var c,d,e;a=a||[],c=o.failSave(),d=_(a).pluck("id"),e=_(d).indexOf(l),c.id=l,e>-1?a.splice(e,1,c):a.push(c),b.add("savepoints",a)})}function q(){b.get("savepoints").done(function(a){var c,d;a=a||[],c=_(a).pluck("id"),d=_(c).indexOf(l),d>-1&&a.splice(d,1),b.add("savepoints",a)})}$(window).on("unload",p),n=setInterval(p,10*1e3),a.extend(this),this.folder=function(){var a,b=null,c=null,d=null,e=function(a){f.set(a.data.folder),o.trigger("folder:refresh"
,a.data.folder)},f={unset:function(){b=null,c&&c.setTitle(""),d&&d.clear()},set:function(a){var f=$.Deferred();return a!==undefined&&a!==null?require(["io.ox/core/api/folder"],function(g){g.get({folder:a}).done(function(h){g.off("change:"+b),b=String(a),g.on("change:"+b,{folder:b},e),c&&(c.setTitle(h.title),c.updateToolbar()),d&&d.prop("folder")!==b&&(d.clear(),d.prop("folder",b),c&&c.getSearchQuery()!==""?(c.setSearchQuery(""),d.setMode("all")):d.refresh(),_.url.hash("folder",b)),o.trigger("folder:change"
,b,h),f.resolve(h)}).fail(f.reject)}):f.reject(),f},setType:function(b){return a=b,this},setDefault:function(){var b=new $.Deferred;return require(["io.ox/core/config"],function(c){var d=a==="mail"?c.get("mail.folder.inbox"):c.get("folder."+a);d?f.set(d).done(b.resolve).fail(b.reject):b.reject()}),b},get:function(){return b},getData:function(){return require(["io.ox/core/api/folder"]).pipe(function(a){return a.get({folder:b})})},updateTitle:function(a){return c=a,this},updateGrid:function(a){return d=
a,this},destroy:function(){f=c=d=null}};return f}(),this.getInstance=function(){return o},this.getId=function(){return e.id},this.setLauncher=function(a){return g=a,this},this.setQuit=function(a){return h=a,this},this.setWindow=function(a){return i=a,i.app=this,"name"in e&&i.nodes.outer.attr("data-app-name",e.name),this},this.getName=function(){return e.name},this.setTitle=function(a){return e.title=a,ox.trigger("application:change:title",this,a),this},this.getTitle=function(){return e.title},this
.getWindow=function(){return i},this.getWindowNode=function(){return $(i.nodes.main)},this.getWindowTitle=function(){return i?i.getTitle():""},this.setState=function(a){var b;for(b in a)_.url.hash(b,String(a[b]))},this.getName=function(){return e.name},this.getState=function(){return _.url.hash()},this.launch=function(){var a;return e.name!==_.url.hash("app")&&(_.url.hash("folder",null),_.url.hash("id",null)),e.name&&_.url.hash("app",e.name),j?i&&(i.show(),a=$.when(),ox.trigger("application:resume"
,o)):(j=!0,(a=g.apply(this,arguments)||$.when()).done(function(){ox.ui.running.push(o),ox.trigger("application:launch",o)})),a.pipe(function(){return $.Deferred().resolveWith(o,arguments)})},this.quit=function(a){var b=a?$.when():h()||$.when();return b.done(function(){var b;a&&o.destroy&&o.destroy(),_.url.hash("app",null),_.url.hash("folder",null),_.url.hash("id",null),ox.ui.running=_(ox.ui.running).without(o),j=!1,clearInterval(n),q(),$(window).off("unload",p),ox.trigger("application:quit",o),o.
events.destroy(),o.folder.destroy(),i&&(i.trigger("quit"),ox.ui.windowManager.trigger("window.quit",i),i.destroy());for(b in o)delete o[b];o=i=g=h=null})}}var b=new d.SimpleCache("app-cache",!0),c=0;return ox.ui.App=e,e.canRestore=function(){return b.get("savepoints").pipe(function(a){return a&&a.length})},e.getSavePoints=function(){return b.get("savepoints").pipe(function(a){return a||[]})},e.restore=function(){e.getSavePoints().done(function(a){$.when.apply($,_(a).map(function(a){return require
([a.module+"/main"]).pipe(function(b){return b.getApp().launch().done(function(){a.id=this.getUniqueId(),this.failRestore&&this.failRestore(a.point)})})})).done(function(){b.add("savepoints",a||[])})})},e.get=function(a){return _(ox.ui.running).filter(function(b){return b.getName()===a})},function(a){return new e(a)}}(),ox.ui.screens=function(){var b=null,c={add:function(a){return $("<div>",{id:"io-ox-"+a}).addClass("abs").hide().appendTo("#io-ox-screens")},get:function(a){return $("#io-ox-screens"
).find("#io-ox-"+a)},current:function(){return b},hide:function(a){this.get(a).hide(),this.trigger("hide-"+a)},show:function(a){$("#io-ox-screens").children().each(function(b,d){var e=$(this).attr("id"),f=String(e||"").substr(6);f!==a&&c.hide(f)}),this.get(a).show(),b=a,this.trigger("show-"+a)}};return a.extend(c),c}(),ox.ui.Perspective=function(){var a=function(a){var b=!1,c=!1;this.main=$(),this.show=function(d){c||(this.main=d.getWindow().addPerspective(a),c=!0),d.getWindow().setPerspective(a)
,b||(this.render(d),b=!0)},this.render=$.noop};return a}(),ox.ui.windowManager=function(){var b=a.extend({}),c=[],d=function(){return _(c).inject(function(a,b){return a+(b.state.open?1:0)},0)};return b.getWindows=function(){return c.slice()},ox.ui.screens.on("hide-windowmanager",function(){e&&e.hide()}),b.hide=function(){ox.ui.screens.hide("windowmanager")},b.show=function(){ox.ui.screens.show("windowmanager")},b.on("window.open window.show",function(a,b){this.show(),c=_(c).without(b),c.unshift(b
)}),b.on("window.beforeshow",function(){b.trigger("empty",!1)}),b.on("window.close window.quit window.pre-quit",function(a,e,f){var g,h,i,j=_(c).indexOf(e);if(j!==-1){if(f==="window.quit")c.splice(j,1);else if(f==="window.close"||f==="window.pre-quit")c=_(c).without(e),c.push(e);for(g=0,h=c.length;g<h;g++){i=c[g];if(i!==e&&i.state.open){i.show();break}}}b.trigger("empty",d()===0)}),b}(),ox.ui.createWindow=function(){var d=0,f=$("#io-ox-windowmanager-pane"),g=function(a){return a.data("x")||0},h=function(
a,b){var c=f.find(".window-container-center"),d=a.find(".window-container-center").show(),e=a.data("index")||0,h=-e*101,i=function(){setTimeout(function(){_.call(b)},10)};h!==g(f)?(f.data("x",h),f.animate({left:h+"%"},0,i)):i()},i=function(a,c){this.id=a,this.name=c,this.nodes={},this.search={query:""},this.state={visible:!1,running:!1,open:!1},this.app=null,this.detachable=!0;var g=!1,i={main:!0},j="main",k=this,l=!0;this.updateToolbar=function(){b.point(this.name+"/toolbar").invoke("draw",this.
nodes.toolbar.empty(),this.app||this)},this.show=function(a){var b=this.nodes.outer,c=b.parent();return e!==this||c.length===0?(l&&b.data("index",d-1).css("left",(d-1)*101+"%"),b.parent().length===0&&b.appendTo(f),ox.ui.windowManager.trigger("window.beforeshow",k),this.trigger("beforeshow"),this.updateToolbar(),b.show(),h(b,function(){e&&e!==k&&e.hide(),e=k,_.call(a),k.state.visible=!0,k.state.open=!0,k.trigger("show"),document.title=ox.serverConfig.pageTitle+k.getTitle(),l&&(k.trigger("open"),k.
state.running=!0,ox.ui.windowManager.trigger("window.open",k),l=!1),ox.ui.windowManager.trigger("window.show",k)})):_.call(a),this},this.hide=function(){return this.trigger("beforehide"),this.detachable&&this.nodes.outer.find("iframe").length===0?this.nodes.outer.detach():this.nodes.outer.hide(),this.state.visible=!1,this.trigger("hide"),ox.ui.windowManager.trigger("window.hide",this),e===this&&(e=null,document.title=ox.serverConfig.pageTitle),this},this.toggle=function(){return e===this?this.hide
():this.show(),this},this.preQuit=function(){return this.hide(),this.state.open=!1,this.trigger("pre-quit"),ox.ui.windowManager.trigger("window.pre-quit",this),this},this.close=function(){var a=this;return g&&this.app!==null?($("#myGrowl").jGrowl("shutdown"),this.trigger("beforequit"),this.app.quit().done(function(){a.state.open=!1,a.state.running=!1,a=null})):(this.hide(),this.state.open=!1,this.trigger("close"),ox.ui.windowManager.trigger("window.close",this)),this};var m="input, select, textarea, button"
,n="toggle-disabled";this.busy=function(){return k&&($("body").focus(),k.nodes.main.find(m).not(":disabled").attr("disabled","disabled").addClass(n),k.nodes.blocker.busy().show(),k.trigger("busy")),this},this.idle=function(a){return k&&(k.nodes.blocker.idle().hide(),k.nodes.main.find(m).filter("."+n).removeAttr("disabled").removeClass(n),k.trigger("idle")),this},this.destroy=function(){return this.hide(),this.trigger("destroy"),this.app!==null&&(this.app.win=null,this.app=null),this.events.destroy
(),this.show=this.busy=this.idle=$.noop,this.nodes.outer.remove(),this.nodes=k=null,this},this.setQuitOnClose=function(a){return g=!!a,this};var o="";function p(){var a=k.nodes.title.find("span");a.eq(0).empty().append(typeof o=="string"?document.createTextNode(o):o)}this.getTitle=function(){return k.nodes.title.find("span").eq(0).contents().text()},this.setTitle=function(a){return o=a,p(),this===e&&(document.title=ox.serverConfig.pageTitle+a),this.trigger("change:title"),this},this.getSearchQuery=
function(){return $.trim(this.nodes.search.val())},this.setSearchQuery=function(a){return this.nodes.search.val(a),this},this.addClass=function(){var a=this.nodes.outer;return a.addClass.apply(a,arguments)},this.addButton=function(a){var b=$.extend({label:"Action",action:$.noop},a||{});return $("<div>").addClass("io-ox-toolbar-link").text(String(b.label)).on("click",b.action).appendTo(this.nodes.toolbar)},this.addPerspective=function(a){if(this.nodes[a]===undefined){var b=$("<div>").addClass("window-content"
).hide().appendTo(this.nodes.body);return this.nodes[a]=i[a]=b}},this.setPerspective=function(a){return a!==j&&i[a]!==undefined&&(this.nodes[j].hide(),this.nodes[j=a].show()),this}};return function(f){var g,h,j,k=$.extend({id:"window-"+d,name:"",width:0,title:"",titleWidth:"300px",search:!1,toolbar:!1,settings:!1,chromesless:!1},f),l=(String(k.width).match(/^(\d+)(px|%)$/)||["","100","%"]).splice(1),m=l[0],n=l[1],o=new i(k.id,k.name),p=function(){o.close()};return o.nodes.outer=$("<div>").attr({id
:k.id,"data-window-nr":d}).addClass("window-container").append($("<div>").addClass("window-container-center").data({width:m+n}).css({width:m+n}).append(o.nodes.blocker=$("<div>").addClass("abs window-blocker").hide()).append(o.nodes.head=$("<div>").addClass("window-head").append(o.nodes.title=$("<h1>").css("width",k.titleWidth).addClass("window-title").append($("<span>"))).append(o.nodes.toolbar=$("<div>").css("left",k.titleWidth).addClass("window-toolbar")).append(o.nodes.controls=$("<div>").addClass
("window-controls").append(o.nodes.settingsButton=$("<div>").hide().addClass("window-control").text("✎")).append(o.nodes.closeButton=$("<div>").hide().addClass("window-control").append($('<a class="close">&times;</a>'))))).append(o.nodes.body=$("<div>").addClass("window-body").append(o.nodes.settings=$("<div>").hide().addClass("window-settings").html("<h2>Each window can have a quick settings area</h2>")).append(o.nodes.main=$("<div>").addClass("window-content")))),a.extend(o),k.search&&(g="",h=function(
a){if(/^porn$/i.test(a))$("body").append($("<div>").addClass("abs").css({backgroundColor:"black",zIndex:65e3}).append($("<div>").addClass("abs").css({top:"25%",textAlign:"center",color:"#aaa",fontWeight:"bold",fontSize:"50px",fontFamily:"'Comic Sans MS', Arial"}).html('<span style="color: rgb(230,110,110)">YOU</span> SEARCHED FOR WHAT?')).append($("<div>").addClass("abs").css({top:"50%",width:"670px",textAlign:"center",margin:"0 auto 0 auto",color:"#666"}).html('<div style="font-size: 26px">WARNING: This website contains explicit adult material.</div>'+'<div style="font-size: 18px">You may only enter this Website if you are at least 18 years of age, or at least the age of majority in the jurisdiction where you reside or from which you access this Website. If you do not meet these requirements, then you do not have permission to use the Website.</div>'
)).click(function(){$(this).remove()}));else if(/^use the force$/i.test(a)&&e){e.nodes.outer.css({webkitTransitionDuration:"2s",webkitTransform:"perspective(500px) rotate3d(1, 0, 0, 45deg)",top:"-150px"});return}else if(/^no star wars$/i.test(a)&&e){e.nodes.outer.css({webkitTransitionDuration:"1s",webkitTransform:"perspective(0px) rotate3d(1, 0, 0, 0deg)",top:""});return}o.trigger("search",a)},j="search_"+_.now(),$("<form>").on("submit",!1).addClass("form-search").css({"float":"right"}).append($("<label>"
,{"for":j}).append(o.nodes.search=$("<input>",{type:"text",placeholder:"Search ...",tabindex:"1",size:"40",id:j}).tooltip({animation:!1,title:"Press &lt;enter> to search,<br>press &lt;esc> to clear",placement:"bottom",trigger:"focus"}).addClass("input-large search-query").on({keydown:function(a){a.stopPropagation(),a.which===27&&($(this).val(""),o.trigger("cancel-search",g=""))},search:function(a){a.stopPropagation(),$(this).val()===""&&$(this).blur()},change:function(a){a.stopPropagation(),o.search
.query=$(this).val(),o.search.query!==""?o.search.query!==g&&h(g=o.search.query):g!==""&&o.trigger("cancel-search",g="")}}))).prependTo(o.nodes.controls)),k.toolbar===!0&&k.name&&b.point(k.name+"/toolbar").extend(new c.ToolbarLinks({id:"links",ref:k.name+"/links/toolbar"})),k.chromeless?(o.nodes.head.remove(),o.nodes.toolbar.remove(),o.nodes.body.css("top","0px")):(k.close===!0&&(o.nodes.closeButton.show().on("click",p),o.setQuitOnClose(!0)),o.setTitle(k.title),k.settings&&($.quickSettings(o.nodes
.main,o.nodes.settings,o.nodes.settingsButton),o.nodes.settingsButton.show())),d++,o}}(),ox.launch=function(a,b){var c=$.Deferred();return _.isString(a)?require([a],function(a){a.getApp(b).launch().done(function(){c.resolveWith(this,arguments)})}):c.resolve({}),c},{addLauncher:h}})