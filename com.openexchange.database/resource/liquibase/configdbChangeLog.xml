<?xml version="1.0" encoding="UTF-8"?>

<!-- *************************************************************************************
    Hints:
       - changeSet id has to be unique as it is used as primary key for DATABASECHANGELOG table
       - use failOnError param to define if a successful execution of the ChangeSet is required
       - DDLs for the configdb have additionally be considered within the configdb.sql file (for new installations)
 ************************************************************************************* -->

<databaseChangeLog xmlns="urn:liquibase"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="urn:liquibase /liquibase/dbchangelog-3.0.xsd"
    logicalFilePath="configdbChangeLog">


    <!-- ******************************************************* -->
    <!-- ************** Release 7.6.1 starts here ************** -->
    <!-- ******************************************************* -->

    <changeSet id="7.6.1-milestone" author="martin.schneider@open-xchange.com">
        <tagDatabase tag="7.6.1-milestone" />
    </changeSet>

    <changeSet id="7.6.1:login2context:login_info" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <customPrecondition
                className="liquibase.precondition.ext.ColumnSizePrecondition">
                <param name="expectedSize" value="255" />
                <param name="tableName" value="login2context" />
                <param name="columnName" value="login_info" />
            </customPrecondition>
        </preConditions>
        <comment>Fix for bug 33418: enhances the login_info column to 255
            characters</comment>
        <modifyDataType columnName="login_info" newDataType="varchar(255)"
            tableName="login2context" />
        <dropDefaultValue columnDataType="varchar(255)"
            columnName="login_info" tableName="login2context" />
        <rollback>
            <dropDefaultValue tableName="login2context"
                columnName="login_info" />
            <modifyDataType tableName="login2context" columnName="login_info"
                newDataType="varchar(128)" />
            <dropDefaultValue columnDataType="varchar(128)"
                columnName="login_info" tableName="login2context" />
        </rollback>
    </changeSet>

    <!-- ******************************************************* -->
    <!-- ************** Release 7.6.2 starts here ************** -->
    <!-- ******************************************************* -->

    <changeSet id="7.6.2:changelog:addprimarykey" author="martin.schneider@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <primaryKeyExists tableName="DATABASECHANGELOG"/>
            </not>
        </preConditions>
        <comment>Add missing primary key for DATABASECHANGELOG</comment>
        <addPrimaryKey columnNames="id, author, filename" tableName="DATABASECHANGELOG" />
    </changeSet>

    <changeSet id="7.6.2:context_server2db_pool:addpoolandschemaindex" author="thorben.betten@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="context_server2db_pool"  columnNames="write_db_pool_id,db_schema"/>
            </not>
        </preConditions>
        <comment>Add index to context_server2db_pool table for columns write_db_pool_id and db_schema</comment>
        <createIndex indexName="poolAndSchema" tableName="context_server2db_pool">
            <column name="write_db_pool_id"/>
            <column name="db_schema"/>
        </createIndex>
        <rollback>
            <dropIndex indexName="poolAndSchema" tableName="context_server2db_pool"/>
        </rollback>
    </changeSet>

    <changeSet id="7.6.2:context2push_registration" author="thorben.betten@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="context2push_registration" />
            </not>
        </preConditions>
        <comment>Creates the 'context2push_registration' table</comment>
        <sql>
            CREATE TABLE context2push_registration (
            cid INT4 UNSIGNED NOT NULL,
            PRIMARY KEY (cid)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
        </sql>
        <rollback>
            <dropTable tableName="context2push_registration" />
        </rollback>
    </changeSet>

    <changeSet id="7.6.2:milestone" author="martin.schneider@open-xchange.com">
        <tagDatabase tag="7.6.2:milestone" />
    </changeSet>

    <!-- ******************************************************* -->
    <!-- ************** Release 7.8.0 starts here ************** -->
    <!-- ******************************************************* -->

     <changeSet id="7.8.0:drop_stored_procedure_configdb_id" author="lars.hoogestraat@open-xchange.com" failOnError="false">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select COUNT(1) from mysql.proc WHERE name='get_configdb_id'</sqlCheck>
        </preConditions>
        <comment>Removes the unused stored procedure 'get_configdb_id' in the configdb</comment>
        <sql>
            DROP PROCEDURE get_configdb_id;
        </sql>
        <rollback>
          <createProcedure>
              CREATE PROCEDURE get_configdb_id() NOT DETERMINISTIC MODIFIES SQL DATA
              BEGIN
                  DECLARE identifier INT4 UNSIGNED;
                  SET identifier = 0;
                  SELECT id INTO identifier FROM configdb_sequence FOR UPDATE;
                  IF 0 = identifier THEN
                      INSERT INTO configdb_sequence (id) VALUES (identifier);
                  END IF;
                  SET identifier = identifier + 1;
                  UPDATE configdb_sequence SET id = identifier;
                  SELECT identifier;
              END;
          </createProcedure>
        </rollback>
    </changeSet>

     <changeSet id="7.8.0:drop_stored_procedure_context_id" author="lars.hoogestraat@open-xchange.com" failOnError="false">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">select COUNT(1) from mysql.proc WHERE name='get_context_id'</sqlCheck>
        </preConditions>
        <comment>Removes the unused stored procedure 'get_context_id' in the configdb</comment>
        <sql>
            DROP PROCEDURE get_context_id;
        </sql>
        <rollback>
          <createProcedure>
            CREATE PROCEDURE get_context_id() NOT DETERMINISTIC MODIFIES SQL DATA
              BEGIN
                START TRANSACTION;
                    UPDATE sequence_context SET id=id+1 WHERE cid=0;
                    SELECT id FROM sequence_context WHERE cid=0;
                COMMIT;
              END;
          </createProcedure>
        </rollback>
    </changeSet>

    <changeSet id="7.8.0:replicationMonitor:createForConfigDB" author="martin.schneider@open-xchange.com" failOnError="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="replicationMonitor" />
            </not>
        </preConditions>
        <comment>
            Add table 'replicationMonitor' for master/slave replication.
        </comment>
        <sql>
            CREATE TABLE replicationMonitor (
                cid int(10) unsigned NOT NULL,
                transaction bigint(20) NOT NULL,
                PRIMARY KEY (cid)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
            INSERT INTO replicationMonitor (cid,transaction) VALUES (0,0);
        </sql>
        <rollback>
            <dropTable tableName="replicationMonitor" />
        </rollback>
    </changeSet>

    <changeSet id="7.8.0:context:addcontextnameunique" author="thorben.betten@open-xchange.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <indexExists tableName="context" columnNames="name"/>
            </not>
        </preConditions>
        <comment>Creates a UNIQUE constraint on name column of the context table</comment>
        <sql>
            ALTER TABLE context ADD UNIQUE KEY `context_name_unique` (name)
        </sql>
        <rollback>
            <dropIndex indexName="context_name_unique" tableName="context_server2db_pool"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
