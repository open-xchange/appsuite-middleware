<project name="Open-Xchange Development Config" default="default" basedir=".">

    <description>
        Open-Xchange Collaboration Suite Server Development Configuration
    </description>
	
    <target name="init">
    	<pathconvert targetos="unix" property="basedir.unix">
    		<path location="${basedir}"/>
    	</pathconvert>
    	<echo message="baseDir: ${basedir.unix}" />
        <property name="tmpDir" value="${basedir.unix}/tmp"/>
    	<echo message="tmpDir: ${tmpDir}" />
        <property name="confDir" value="${basedir.unix}/conf"/>
    	<echo message="confDir: ${confDir}" />
    	<property name="solrDir" value="${basedir.unix}/solr" />
    	<echo message="solrDir: ${solrDir}" />
    	<property name="snappyDir" value="${basedir.unix}/snappy" />
    	<echo message="snappyDir: ${snappyDir}" />
    </target>

    <target name="prepare" depends="init">
        <mkdir dir="${tmpDir}"/>
    </target>

    <target name="patchConfig" depends="prepare">
        <copy todir="${tmpDir}" overwrite="true">
            <fileset dir="${confDir}"/>
        </copy>
        <antcall target="patchConfigFiles">
            <param name="confSubstPatch" value="${tmpDir}"/>
            <param name="patchConfDir" value="${tmpDir}"/>
        </antcall>
    </target>

    <target name="install">
        <antcall target="patchConfig"/>
    </target>

    <target name="default" depends="install"/>

    <target name="clean" depends="init">
        <delete dir="${tmpDir}"/>
    </target>

    <target name="patchConfigFiles">
        <fail message="Define confSubstPatch." unless="confSubstPatch"/>
    	<antcall target="patchCrawlerProperties"/>
        <antcall target="patchPath"/>
        <antcall target="patchDataRetentionProperties"/>
        <antcall target="patchServerProperties"/>
    	<antcall target="pathSolrProperties"/>
    	<antcall target="pathSnappyProperties"/>
    </target>
	
	<target name="pathSolrProperties">
		<replace dir="${patchConfDir}">
		    <replacefilter token="@oxsolrdir@" value="${solrDir}"/>
		</replace>
	</target>
	
	<target name="pathSnappyProperties">
		<replace dir="${patchConfDir}">
		    <replacefilter token="@oxsnappydir@" value="${snappyDir}"/>
		</replace>
	</target>

    <target name="patchPath">
        <move todir="${patchConfDir}" includeemptydirs="false">
            <fileset dir="${patchConfDir}">
                <include name="*.in"/>
            </fileset>
            <mapper type="glob" from="*.in" to="*"/>
        </move>
        <replace dir="${patchConfDir}">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${confSubstPatch}"/>
            <replacefilter token="@oxconfdir@" value="${confSubstPatch}"/>
        </replace>
    </target>

	<target name="patchServerProperties">
    	<pathconvert targetos="unix" property="uploadDir">
    		<path location="${java.io.tmpdir}"/>
    	</pathconvert>
        <replace file="${patchConfDir}/server.properties" token="UPLOAD_DIRECTORY=/tmp/" value="UPLOAD_DIRECTORY=${uploadDir}" />
	</target>
	
	<target name="patchCrawlerProperties">
        <move tofile="${patchConfDir}/crawler.properties" file="${patchConfDir}/crawler.properties.in" overwrite="true"/>
        <replace file="${patchConfDir}/crawler.properties">
            <replacefilter token="@oxgroupwaresysconfdir@" value="${basedir.unix}"/>
        </replace>
	</target>

    <target name="patchDataRetentionProperties">
        <replace file="${patchConfDir}/dataretention.properties" token="com.openexchange.dataretention.dir=/var/log/open-xchange" value="com.openexchange.dataretention.dir=${patchConfDir}" />
    </target>

</project>
