#!/bin/bash

OXFUNCTIONS=@oxfunctions@
OXCONFIG=@oxscriptconf@
OXPREFIX=@prefix@
CONSOLELOG=@consolelogfile@

test -f $OXFUNCTIONS || {
	echo "missing common shell functions file"
	exit 1
}

. $OXFUNCTIONS

test -f $OXCONFIG && . $OXCONFIG

ox_set_JAVA_BIN

ox_update_config_init @configini@ @configini@.template @bundle.d@

test -z "$JAVA_XTRAOPTS" && JAVA_XTRAOPTS="-Xms50M -Xmx50M"

JAVA_OPTS="${JAVA_XTRAOPTS} \
-Djava.awt.headless=true \
-Dopenexchange.propdir=$PROPERTIESDIR \
-Djava.util.logging.config.file=$LOGGINGPROPERTIES"

CLASSPATH=""

if [ -d @oxgroupwaresysconfdir@/log4j ]; then
    CLASSPATH="${CLASSPATH}:@oxgroupwaresysconfdir@/log4j"
fi

if [ -n "$CLASSPATH" ]; then
	CLASSPATH="-classpath $CLASSPATH"
fi

pushd $OXPREFIX

rm -f $CONSOLELOG
OSGICACHEDIR=${OSGIPATH}/org.eclipse.osgi
test -d $OSGICACHEDIR && rm -rf $OSGICACHEDIR

umask 066
exec $JAVA_BIN $JAVA_OPTS $CLASSPATH -jar /opt/open-xchange/bundles/org.eclipse.osgi_3.3.0.v20070530.jar -configuration file:$OSGIPATH > $CONSOLELOG 2>&1
